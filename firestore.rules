rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function intOrZero(value) {
      return value is int ? value : 0;
    }

    match /users/{userId} {
      // Perfiles visibles solo para usuarios autenticados (evitar exponer datos a anónimos).
      allow read: if isSignedIn();

      allow create: if isSelf(userId)
        && request.resource.data.id == userId
        && request.resource.data.keys().hasOnly([
          'id',
          'username',
          'name',
          'createdAt',
          'followersCount',
          'followingCount',
          'accountStatus'
        ])
        && request.resource.data.createdAt == request.time
        && intOrZero(request.resource.data.followersCount) == 0
        && intOrZero(request.resource.data.followingCount) == 0
        && request.resource.data.accountStatus == 'active';

      // Update del propio perfil + caso especial: incremento/decremento de followersCount por el follower.
      allow update: if (isSelf(userId) && isValidSelfUserUpdate())
        || (!isSelf(userId) && isValidFollowerCountUpdate(userId));

      allow delete: if isSelf(userId);

      function isValidSelfUserUpdate() {
        return request.resource.data.id == resource.data.id
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'username',
            'name',
            'bio',
            'photoUrl',
            'updatedAt',
            'accountStatus',
            'pausedAt',
            'followersCount',
            'followingCount'
          ]);
      }

      function isValidFollowerCountUpdate(targetUserId) {
        return isSignedIn()
          && request.resource.data.id == resource.data.id
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['followersCount', 'updatedAt'])
          && (
            (
              intOrZero(request.resource.data.followersCount) == intOrZero(resource.data.followersCount) + 1
              && !exists(/databases/$(database)/documents/users/$(targetUserId)/followers/$(request.auth.uid))
              && existsAfter(/databases/$(database)/documents/users/$(targetUserId)/followers/$(request.auth.uid))
            )
            || (
              intOrZero(request.resource.data.followersCount) == intOrZero(resource.data.followersCount) - 1
              && exists(/databases/$(database)/documents/users/$(targetUserId)/followers/$(request.auth.uid))
              && !existsAfter(/databases/$(database)/documents/users/$(targetUserId)/followers/$(request.auth.uid))
            )
          );
      }

      match /FavRecipes/{docId} {
        allow read, create, update, delete: if isSelf(userId);
      }

      match /Categories/{categoryId} {
        allow read, create, update, delete: if isSelf(userId);
      }

      match /following/{targetUserId} {
        allow read: if isSelf(userId);
        allow create: if isSelf(userId)
          && request.resource.data.keys().hasOnly(['createdAt'])
          && request.resource.data.createdAt == request.time;
        allow delete: if isSelf(userId);
        allow update: if false;
      }

      match /followers/{followerId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
          && request.auth.uid == followerId
          && request.resource.data.keys().hasOnly(['createdAt'])
          && request.resource.data.createdAt == request.time;
        allow delete: if isSignedIn() && request.auth.uid == followerId;
        allow update: if false;
      }
    }

    match /PublishedRecipes/{recipeId} {
      // Feed público
      allow read: if true;

      allow create: if isSignedIn()
        && request.resource.data.authorId == request.auth.uid
        && isValidPublishedCreate();

      allow update: if isSignedIn() && (
        isValidPublishedAuthorUpdate() ||
        isValidPublishedAnonymizeUpdate() ||
        isValidPublishedLikeCountUpdate(recipeId) ||
        isValidPublishedSaveCountUpdate(recipeId) ||
        isValidPublishedShareCountUpdate()
      );

      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;

      function isValidPublishedCreate() {
        return request.resource.data.keys().hasOnly([
          'authorId',
          'title',
          'imageUrl',
          'ingredients',
          'steps',
          'readyInMinutes',
          'difficulty',
          'nutrition',
          'likesCount',
          'savesCount',
          'sharesCount',
          'createdAt'
        ])
        && request.resource.data.title is string
        && request.resource.data.imageUrl is string
        && request.resource.data.ingredients is list
        && request.resource.data.steps is list
        && intOrZero(request.resource.data.likesCount) >= 0
        && intOrZero(request.resource.data.savesCount) >= 0
        && intOrZero(request.resource.data.sharesCount) >= 0
        && request.resource.data.createdAt == request.time;
      }

      function isValidPublishedAuthorUpdate() {
        // El autor puede editar contenido, no contadores.
        return resource.data.authorId == request.auth.uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'title',
            'imageUrl',
            'ingredients',
            'steps',
            'readyInMinutes',
            'difficulty',
            'nutrition',
            'updatedAt'
          ])
          && request.resource.data.authorId == resource.data.authorId
          && request.resource.data.likesCount == resource.data.likesCount
          && request.resource.data.savesCount == resource.data.savesCount
          && request.resource.data.sharesCount == resource.data.sharesCount
          && request.resource.data.createdAt == resource.data.createdAt;
      }

      function isValidPublishedAnonymizeUpdate() {
        // Caso: borrar cuenta manteniendo recetas (accountService) => authorId -> 'anonymous'
        return resource.data.authorId == request.auth.uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['authorId', 'authorDeletedAt', 'updatedAt'])
          && request.resource.data.authorId == 'anonymous'
          && request.resource.data.authorDeletedAt == request.time
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.likesCount == resource.data.likesCount
          && request.resource.data.savesCount == resource.data.savesCount
          && request.resource.data.sharesCount == resource.data.sharesCount;
      }

      function isValidPublishedLikeCountUpdate(targetRecipeId) {
        return request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount'])
          && intOrZero(request.resource.data.likesCount) >= 0
          && (
            (
              intOrZero(request.resource.data.likesCount) == intOrZero(resource.data.likesCount) + 1
              && !exists(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/likes/$(request.auth.uid))
              && existsAfter(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/likes/$(request.auth.uid))
            )
            || (
              intOrZero(request.resource.data.likesCount) == intOrZero(resource.data.likesCount) - 1
              && exists(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/likes/$(request.auth.uid))
              && !existsAfter(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/likes/$(request.auth.uid))
            )
          );
      }

      function isValidPublishedSaveCountUpdate(targetRecipeId) {
        return request.resource.data.diff(resource.data).changedKeys().hasOnly(['savesCount'])
          && intOrZero(request.resource.data.savesCount) >= 0
          && (
            (
              intOrZero(request.resource.data.savesCount) == intOrZero(resource.data.savesCount) + 1
              && !exists(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/saves/$(request.auth.uid))
              && existsAfter(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/saves/$(request.auth.uid))
            )
            || (
              intOrZero(request.resource.data.savesCount) == intOrZero(resource.data.savesCount) - 1
              && exists(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/saves/$(request.auth.uid))
              && !existsAfter(/databases/$(database)/documents/PublishedRecipes/$(targetRecipeId)/saves/$(request.auth.uid))
            )
          );
      }

      function isValidPublishedShareCountUpdate() {
        return request.resource.data.diff(resource.data).changedKeys().hasOnly(['sharesCount'])
          && intOrZero(request.resource.data.sharesCount) == intOrZero(resource.data.sharesCount) + 1
          && intOrZero(request.resource.data.sharesCount) >= 0;
      }

      match /likes/{userId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(['createdAt'])
          && request.resource.data.createdAt == request.time;
        allow delete: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
      }

      match /saves/{userId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(['createdAt'])
          && request.resource.data.createdAt == request.time;
        allow delete: if isSignedIn() && request.auth.uid == userId;
        allow update: if false;
      }
    }

    match /RecipeReports/{reportId} {
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'reporterId',
          'targetType',
          'targetId',
          'title',
          'reason',
          'createdAt'
        ])
        && request.resource.data.reporterId == request.auth.uid
        && request.resource.data.createdAt == request.time;

      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
